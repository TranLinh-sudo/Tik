--[[ CẤU HÌNH ]]
-- Dán link MỚI NHẤT của bạn vào đây (Nhớ đuôi /api/update)
local SERVER_URL = "https://77c1a2045beb1f.lhr.life/api/update" 

-----------------------------------------------------------
-- SCRIPT THEO DÕI V3 (CÓ GIAO DIỆN BÁO LỖI)
-----------------------------------------------------------
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- 1. TẠO GIAO DIỆN NHỎ GÓC TRÊN ĐỂ BIẾT SCRIPT CÒN SỐNG KHÔNG
local ScreenGui = Instance.new("ScreenGui")
local StatusLabel = Instance.new("TextLabel")

ScreenGui.Name = "BloxManagerGUI"
ScreenGui.Parent = CoreGui -- Nhét vào CoreGui để Tool Farm khó xóa hơn
StatusLabel.Parent = ScreenGui
StatusLabel.Size = UDim2.new(0, 200, 0, 30)
StatusLabel.Position = UDim2.new(0.5, -100, 0, 10) -- Ở giữa trên cùng
StatusLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
StatusLabel.Text = "Blox Manager: Đang khởi động..."
StatusLabel.BackgroundTransparency = 0.5

-- Hàm gửi HTTP
local request = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request

local function getInventory()
    local list = {}
    pcall(function()
        local raw = game:GetService("ReplicatedStorage").Remotes["CommF_"]:InvokeServer("getInventory")
        for _, v in pairs(raw) do
            if v.Type == "Blox Fruit" then
                -- Lọc tên trái xịn
                local name = string.match(v.Name, "^(.-)-") or v.Name
                if table.find({"Kitsune","Dragon","Leopard","Dough","T-Rex","Spirit","Venom","Control","Mammoth","Shadow","Buddha"}, name) then
                    table.insert(list, name)
                end
            end
        end
    end)
    return table.concat(list, ", ")
end

-- VÒNG LẶP CHÍNH
task.spawn(function()
    while true do
        task.wait(5) -- 5 giây gửi 1 lần
        
        -- Nếu giao diện bị Tool Farm xóa -> Tự tạo lại
        if not CoreGui:FindFirstChild("BloxManagerGUI") then
            ScreenGui.Parent = CoreGui
        end

        local success, err = pcall(function()
            local data = LocalPlayer:FindFirstChild("Data")
            if not data then 
                StatusLabel.Text = "Đang đợi Game load..."
                return 
            end

            StatusLabel.Text = "Đang gửi dữ liệu..."
            StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 0) -- Màu vàng

            local payload = {
                id = LocalPlayer.Name,
                displayName = LocalPlayer.DisplayName,
                data = {
                    level = data.Level.Value,
                    beli = data.Beli.Value,
                    fragments = data.Fragments.Value,
                    inventory = getInventory()
                }
            }

            local response = request({
                Url = SERVER_URL,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode(payload)
            })

            -- Kiểm tra kết quả
            if response.StatusCode == 200 then
                StatusLabel.Text = "✅ Đã gửi: " .. os.date("%H:%M:%S")
                StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 0) -- Màu xanh
            else
                StatusLabel.Text = "❌ Lỗi Server: " .. response.StatusCode
                StatusLabel.TextColor3 = Color3.fromRGB(255, 0, 0) -- Màu đỏ
            end
        end)

        if not success then
            StatusLabel.Text = "⚠️ Lỗi Script/Mạng!"
            StatusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
        end
    end
end)
